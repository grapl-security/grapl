# This file exists solely to coordinate the build of Grapl service
# containers.
#
# At the moment, these are "local" Grapl containers, and not
# necessarily identical to the artifacts we would use in real
# deployments.
version: "3.8"

services:

  ########################################################################
  # Rust Services
  ########################################################################

  grapl-rust-build:
    image: grapl/grapl-rust-build:${TAG:-latest}
    build:
      context: src
      dockerfile: rust/Dockerfile
      target: grapl-rust-build
      args:
        - TAG=${TAG:-latest}

  rust-dist:
    image: grapl/rust-dist:${TAG:-latest}
    build:
      context: src
      dockerfile: rust/Dockerfile
      target: rust-dist
      args:
        - TAG=${TAG:-latest}

  grapl-sysmon-subgraph-generator:
    image: grapl/grapl-sysmon-subgraph-generator:${TAG:-latest}
    build:
      context: src
      dockerfile: rust/Dockerfile
      target: sysmon-subgraph-generator
      args:
        - CARGO_PROFILE=${CARGO_PROFILE:-debug}

  grapl-osquery-subgraph-generator:
    image: grapl/grapl-osquery-subgraph-generator:${TAG:-latest}
    build:
      context: src
      dockerfile: rust/Dockerfile
      target: osquery-subgraph-generator
      args:
        - CARGO_PROFILE=${CARGO_PROFILE:-debug}

  grapl-node-identifier:
    image: grapl/grapl-node-identifier:${TAG:-latest}
    build:
      context: src
      dockerfile: rust/Dockerfile
      target: node-identifier
      args:
        - CARGO_PROFILE=${CARGO_PROFILE:-debug}

  grapl-node-identifier-retry-handler:
    image: grapl/grapl-node-identifier-retry-handler:${TAG:-latest}
    build:
      context: src
      dockerfile: rust/Dockerfile
      target: node-identifier-retry-handler
      args:
        - CARGO_PROFILE=${CARGO_PROFILE:-debug}

  grapl-graph-merger:
    image: grapl/grapl-graph-merger:${TAG:-latest}
    build:
      context: src
      dockerfile: rust/Dockerfile
      target: graph-merger
      args:
        - CARGO_PROFILE=${CARGO_PROFILE:-debug}

  grapl-analyzer-dispatcher:
    image: grapl/grapl-analyzer-dispatcher:${TAG:-latest}
    build:
      context: src
      dockerfile: rust/Dockerfile
      target: analyzer-dispatcher
      args:
        - CARGO_PROFILE=${CARGO_PROFILE:-debug}

  ########################################################################
  # Python Services
  ########################################################################

  grapl-python-build:
    image: grapl/grapl-python-build:${TAG:-latest}
    build:
      context: src
      dockerfile: ./python/Dockerfile
      target: grapl-python-build
      args:
        - TAG=${TAG:-latest}

  grapl-analyzer-executor:
    image: grapl/grapl-analyzer-executor:${TAG:-latest}
    build:
      context: src
      dockerfile: ./python/Dockerfile
      target: analyzer-executor
      args:
        - TAG=${TAG:-latest}

  grapl-ux-router:
    image: grapl/grapl-ux-router:${TAG:-latest}
    build:
      context: src
      dockerfile: ./python/Dockerfile
      target: grapl-ux-router
      args:
        - TAG=${TAG:-latest}

  grapl-engagement-creator:
    image: grapl/grapl-engagement-creator:${TAG:-latest}
    build:
      context: src
      dockerfile: ./python/Dockerfile
      target: engagement-creator
      args:
        - TAG=${TAG:-latest}

  # TODO: really, this service should be grapl-auth
  grapl-engagement-edge:
    image: grapl/grapl-engagement-edge:${TAG:-latest}
    build:
      context: src
      dockerfile: ./python/Dockerfile
      target: engagement-edge
      args:
        - TAG=${TAG:-latest}

  grapl-model-plugin-deployer:
    image: grapl/grapl-model-plugin-deployer:${TAG:-latest}
    build:
      context: src
      dockerfile: ./python/Dockerfile
      target: model-plugin-deployer
      args:
        - TAG=${TAG:-latest}

  grapl-dgraph-ttl:
    image: grapl/grapl-dgraph-ttl:${TAG:-latest}
    build:
      context: src
      dockerfile: ./python/Dockerfile
      target: dgraph-ttl
      args:
        - TAG=${TAG:-latest}

  ########################################################################
  # Web Services
  ########################################################################

  engagement-view-deps:
    image: grapl/engagement-view-deps:${TAG:-latest}
    build:
      context: src
      dockerfile: js/engagement_view/Dockerfile
      target: engagement-view
      args:
        - TAG=${TAG:-latest}

  grapl-engagement-view-uploader:
    image: grapl/grapl-engagement-view:${TAG:-latest}
    build:
      context: src
      dockerfile: js/engagement_view/Dockerfile
      target: engagement-view
      args:
        - TAG=${TAG:-latest}

  graphql-endpoint-build:
    image: grapl/graphql-endpoint-build:${TAG:-latest}
    build:
      context: src
      dockerfile: js/graphql_endpoint/Dockerfile
      target: graphql-endpoint-build
      args:
        - TAG=${TAG:-latest}

  grapl-graphql-endpoint:
    image: grapl/grapl-graphql-endpoint:${TAG:-latest}
    build:
      context: src
      dockerfile: js/graphql_endpoint/Dockerfile
      target: graphql-endpoint
      args:
        - TAG=${TAG:-latest}

  grapl-notebook:
    image: grapl/grapl-notebook:${TAG:-latest}
    build:
      context: src
      dockerfile: ./python/Dockerfile
      target: grapl-notebook
      args:
        - TAG=${TAG:-latest}

  ########################################################################
  # Utility Services
  ########################################################################

  grapl-provision:
    image: grapl/grapl-provision:${TAG:-latest}
    build:
      context: src
      dockerfile: ./python/Dockerfile
      target: grapl-provision
      args:
        - TAG=${TAG:-latest}

  grapl-pulumi:
    image: grapl/grapl-local-pulumi:${TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile.pulumi
      args:
        - TAG=${TAG:-latest}
