### Port conventions (though there are many, many exceptions)
# 82xx - TBD
# 83xx - grapl plugin services, like grapl-aws-plugins
# 84xx - debugger ports (see vsc_debugger.py)

version: "3.8"
volumes:
  dgraph_export:

x-common-variables:
  pulumi-common: &pulumi-common
    image: grapl/local-pulumi:${TAG:-latest}
    entrypoint: ["/bin/bash", "-o", "errexit", "-o", "nounset", "-c"]

    volumes:
      - type: bind
        source: ./dist
        target: /home/grapl/dist
        read_only: true
    environment:
      TAG:
      PULUMI_CONFIG_PASSPHRASE: local-grapl-passphrase
      # This gets exported to True by `make test-integration`
      SHOULD_DEPLOY_INTEGRATION_TESTS: "${SHOULD_DEPLOY_INTEGRATION_TESTS:-False}"
      DOCKER_USER: "${UID}:${GID}"
      GRAPL_ROOT: "${GRAPL_ROOT}"
      # Other environment variables like MG_ALPHAS are passed in via
      # Pulumi.local-grapl.yaml
    extra_hosts:
      # Expose the host Linux machine, despite being on the Grapl network.
      # This lets Pulumi talk to the host's Nomad
      - "host.docker.internal:host-gateway"

services:
  pulumi:
    <<: *pulumi-common
    command:
      - |
        pulumi login --local

        cd grapl
        pulumi stack init local-grapl --non-interactive
        pulumi up --yes --skip-preview --stack=local-grapl
        cd -
        if [[ $SHOULD_DEPLOY_INTEGRATION_TESTS ]]; then
          cd integration_tests
          # Ideally this would be scoped by organizations, but login --local 
          # doesn't support organizations
          pulumi stack init local-grapl-integration-tests --non-interactive
          pulumi up --yes --skip-preview --stack=local-grapl-integration-tests
          cd -
        fi
