version: "3.8"

# environment variable PWD is assumed to be grapl root directory

x-common-variables:
  read-only-pulumi-mnt: &read-only-pulumi-mnt
    type: volume
    source: pulumi_outputs
    target: /mnt/pulumi-outputs
    read_only: true

services:
  e2e-tests:
    image: grapl/e2e-tests:${TAG:-latest}
    build:
      context: .
      dockerfile: ./src/python/lambdas.Dockerfile
      target: e2e-tests
    entrypoint: ["/bin/bash", "-o", "errexit", "-o", "nounset", "-c"]
    command:
      - |
        export GRAPL_ANALYZERS_BUCKET=$$(cat /mnt/pulumi-outputs/analyzers-bucket)
        export GRAPL_OSQUERY_GENERATOR_QUEUE=$$(cat /mnt/pulumi-outputs/osquery-generator-queue)
        export GRAPL_OSQUERY_LOG_BUCKET=$$(cat /mnt/pulumi-outputs/osquery-log-bucket)
        export GRAPL_SYSMON_GENERATOR_QUEUE=$$(cat /mnt/pulumi-outputs/sysmon-generator-queue)
        export GRAPL_SYSMON_LOG_BUCKET=$$(cat /mnt/pulumi-outputs/sysmon-log-bucket)
        export GRAPL_SCHEMA_TABLE=$$(cat /mnt/pulumi-outputs/schema-table)
        export GRAPL_SCHEMA_PROPERTIES_TABLE=$$(cat /mnt/pulumi-outputs/schema-properties-table)

        graplctl \
              --grapl-region $AWS_REGION \
              --grapl-deployment-name $DEPLOYMENT_NAME \
              --grapl-version $DEPLOYMENT_NAME \
              --aws-profile default \
              upload analyzer \
              --analyzer_main_py ./etc/local_grapl/suspicious_svchost/main.py
        graplctl \
              --grapl-region $AWS_REGION \
              --grapl-deployment-name $DEPLOYMENT_NAME \
              --grapl-version $DEPLOYMENT_NAME \
              --aws-profile default \
              upload analyzer \
              --analyzer_main_py ./etc/local_grapl/unique_cmd_parent/main.py
        graplctl \
              --grapl-region $AWS_REGION \
              --grapl-deployment-name $DEPLOYMENT_NAME \
              --grapl-version $DEPLOYMENT_NAME \
              --aws-profile default \
              upload sysmon \
              --logfile ./etc/sample_data/eventlog.xml
        python3 -c 'import lambdex_handler; lambdex_handler.handler(None, None)'
    volumes:
      - dynamodb_dump:/mnt/dynamodb_dump
      - ${PWD}/etc:/home/grapl/etc:ro
      - *read-only-pulumi-mnt
    environment:
      - AWS_REGION
      - DEBUG_SERVICES=${DEBUG_SERVICES:-}
      - DEPLOYMENT_NAME
      - GRAPL_API_HOST
      - GRAPL_AWS_ACCESS_KEY_ID
      - GRAPL_AWS_ACCESS_KEY_SECRET
      - GRAPL_AWS_ENDPOINT
      - GRAPL_HTTP_FRONTEND_PORT
      - GRAPL_LOG_LEVEL
      - GRAPL_TEST_USER_NAME
      - IS_LOCAL=True
      - MG_ALPHAS
      - VSC_DEBUGGER_PORT
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BROKER_HOST}:9092
    ports:
      - ${VSC_DEBUGGER_PORT_FOR_GRAPL_E2E_TESTS}:${VSC_DEBUGGER_PORT_FOR_GRAPL_E2E_TESTS}

volumes:
  dynamodb_dump:
  pulumi_outputs:
networks:
  default:
    name: grapl-network
