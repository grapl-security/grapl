# This file borrows heavily from the pattern defined in `pipeline-infrastructure`.

---
env:
  PANTS_CONFIG_FILES: "['pants.toml', 'pants.ci.toml']"

# This is defined in a separate pipeline file because
# chronotc/monorepo-diff does not currently have support for plugin
# (or key) configuration on commands.
#
# :(

steps:
<<<<<<< HEAD
  - label: ":packer: AMI Test Build"
    command: ".buildkite/scripts/test_packer.sh"
    key: "ami-test" # Used to tag the Packer Builder instance
=======
  - label: ":packer: AMI Test Build: Server"
    command: ".buildkite/scripts/lib/packer_integration_test.sh"
    env:
      PACKER_IMAGE_NAME: "grapl-nomad-consul-server"
    plugins:
      - docker#v3.8.0:
          image: "hashicorp/packer:1.7.2"
          entrypoint: bash
          # No need for propagate-aws-auth-tokens - packer automatically uses the metadata
    agents:
      # TODO: change this to a different queue
      # https://github.com/grapl-security/issue-tracker/issues/613
      queue: "packer"

  - label: ":packer: AMI Test Build: Client"
    command: ".buildkite/scripts/lib/packer_integration_test.sh"
    env:
      PACKER_IMAGE_NAME: "grapl-nomad-consul-client"
>>>>>>> Parallelize AMI builds, and add loooots of testing
    plugins:
      - docker#v3.8.0:
          image: "hashicorp/packer:1.7.2"
          entrypoint: bash
          environment:
            - "BUILDKITE_BRANCH"
            - "BUILDKITE_BUILD_NUMBER"
            - "BUILDKITE_COMMIT"
            - "BUILDKITE_PIPELINE_NAME"
            - "BUILDKITE_STEP_KEY"

    agents:
      # TODO: change this to a different queue
      # https://github.com/grapl-security/issue-tracker/issues/613
      queue: "packer"
