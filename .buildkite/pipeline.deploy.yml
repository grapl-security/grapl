---
env:
  PANTS_CONFIG_FILES: "['pants.toml', 'pants.ci.toml']"
  BUILDKITE_PLUGIN_VAULT_ENV_SECRET_PREFIX: "secret/data/buildkite/env"

steps:
  - label: ":pulumi: Update grapl/customer-mock1 environment in customer-mock1 account"
    plugins:
      - grapl-security/vault-login#v0.1.0
      - grapl-security/vault-env#v0.1.0:
          secrets:
            - PULUMI_ACCESS_TOKEN
      - grapl-security/pulumi#v0.1.2:
          command: update
          project_dir: pulumi/grapl
          stack: grapl/customer-mock1
    agents:
      queue: "pulumi-customer-mock1"

  - label: ":pulumi: Update grapl/customer-mock2 environment in customer-mock2 account"
    plugins:
      - grapl-security/vault-login#v0.1.0
      - grapl-security/vault-env#v0.1.0:
          secrets:
            - PULUMI_ACCESS_TOKEN
      - grapl-security/pulumi#v0.1.2:
          command: update
          project_dir: pulumi/grapl
          stack: grapl/customer-mock2
    agents:
      queue: "pulumi-customer-mock2"

  - wait

  - label: ":writing_hand: Record successful build"
    command:
      - record_successful_pipeline_run.sh
    plugins:
      - grapl-security/grapl-release#v0.1.0