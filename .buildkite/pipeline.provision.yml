---
env:
  PANTS_CONFIG_FILES: "['pants.toml', 'pants.ci.toml']"
  BUILDKITE_PLUGIN_VAULT_ENV_SECRET_PREFIX: "secret/data/buildkite/env"

steps:
  - label: ":pulumi: Preview grapl/testing environment changes in Staging account"
    plugins:
      - grapl-security/vault-login#v0.1.0
      - grapl-security/vault-env#v0.1.0:
          secrets:
            - PULUMI_ACCESS_TOKEN
      - grapl-security/pulumi#v0.1.1:
          command: preview
          project_dir: pulumi/grapl
          stack: grapl/testing
    agents:
      queue: "pulumi-staging"

  - wait

  - label: ":pulumi: Update grapl/testing environment in Staging account"
    plugins:
      - grapl-security/vault-login#v0.1.0
      - grapl-security/vault-env#v0.1.0:
          secrets:
            - PULUMI_ACCESS_TOKEN
      - grapl-security/pulumi#v0.1.1:
          command: update
          project_dir: pulumi/grapl
          stack: grapl/testing
    agents:
      queue: "pulumi-staging"

  - wait

  - trigger: "grapl-testing"
    label: ":rocket: Trigger testing pipeline"
    # Since this is asynchronous, this pipeline will pass or fail
    # based on whether the triggered pipeline passes or fails.
    async: false
    build:
      commit: "${BULIDKITE_COMMIT}"
      branch: "${BUILDKITE_BRANCH}"

  - wait

  - label: ":writing_hand: Record successful build"
    command:
      - .buildkite/shared/steps/record_successful_pipeline_run.sh
