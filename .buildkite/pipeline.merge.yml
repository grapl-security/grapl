---
env:
  PANTS_CONFIG_FILES: "['pants.toml', 'pants.ci.toml']"
  BUILDKITE_PLUGIN_VAULT_ENV_SECRET_PREFIX: "secret/data/buildkite/env"

steps:
  - label: ":docker: Build Docker Containers"
    command:
      - ".buildkite/scripts/build_and_upload_containers.sh"
    key: "docker-containers"
    plugins:
      - grapl-security/vault-login#v0.1.0
      - grapl-security/vault-env#v0.1.0:
          secrets:
            - CLOUDSMITH_API_KEY
      - docker-login#v2.0.1:
          username: grapl-cicd
          password-env: CLOUDSMITH_API_KEY
          server: docker.cloudsmith.io
    agents:
      queue: "docker"
    artifact_paths:
      - "*.grapl-artifacts.json"

  - wait

  # Downloads and operates on all the *.grapl-artifacts.json files
  # that were uploaded in any previous steps of this pipeline.
  - label: "Merge artifacts files"
    command:
      - .buildkite/scripts/merge_artifact_files.sh

  - wait

  - label: ":medal: Create new release candidate"
    command:
      - .buildkite/scripts/create_new_rc.sh
    plugins:
      - grapl-security/vault-login#v0.1.0
      - grapl-security/vault-env#v0.1.0:
          secrets:
            - PULUMI_ACCESS_TOKEN
    env:
      # We're going to be doing some git manipulation, so it's best if
      # we have a clean slate.
      BUILDKITE_CLEAN_CHECKOUT: true
    agents:
      queue: "rc"

  - wait

  - label: ":writing_hand: Record successful build"
    command:
      - .buildkite/shared/steps/record_successful_pipeline_run.sh
